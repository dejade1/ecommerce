# Diagrama de Arquitectura - Sistema de Lotes FIFO

## Arquitectura General

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     APLICACIÃ“N E-COMMERCE                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚             â”‚             â”‚
                â–¼             â–¼             â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   Tienda     â”‚  â”‚ Carrito â”‚  â”‚ Dashboard  â”‚
        â”‚   Frontend   â”‚  â”‚         â”‚  â”‚ Admin      â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚             â”‚             â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                        â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
                        â”‚  Checkout  â”‚
                        â”‚  createOrder()
                        â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                              â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                     â”‚                     â”‚
        â–¼                     â–¼                     â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Inventoryâ”‚      â”‚ consumeBatchesFIFO()  â”‚   LED    â”‚
    â”‚  Update  â”‚      â”‚ batch-service.ts â”‚    â”‚ Manager  â”‚
    â”‚  Stock   â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
                              â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Batch Database  â”‚
                    â”‚ (product_batches)â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Flujo de Venta con FIFO

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Compra en   â”‚
â”‚ E-commerce  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ createOrder()    â”‚
â”‚ inventory.ts     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€ Valida stock total
       â”œâ”€ Crea orden
       â”œâ”€ Crea items de orden
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ consumeBatchesFIFO()     â”‚
â”‚ batch-service.ts        â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€ Obtiene todos los lotes del producto
       â”œâ”€ Ordena por fecha de caducidad (ASC)
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Recorre lotes ordenados â”‚
â”‚   (mÃ¡s antiguos primero)â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€ Â¿Lote tiene stock suficiente?
       â”‚
       â”œâ”€ SÃ â”€â”€â†’ Descuenta cantidad necesaria
       â”‚         â”‚ Reduce stock del lote
       â”‚         â””â”€ Termina
       â”‚
       â””â”€ NO â”€â”€â†’ Descuenta todo lo que puede
                 â”‚ Reduce a 0 el lote
                 â””â”€ ContinÃºa con siguiente lote
       
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ updateStock('out')   â”‚
â”‚ Reduce stock general â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Venta Completada â”‚
â”‚ FIFO Aplicado âœ“  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Interfaces de Usuario

### Panel de AdministraciÃ³n - Tabs

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Panel de AdministraciÃ³n                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [Inventario] [Productos] [Stock] [Ventas] [Usuarios]       â”‚
â”‚ [Lotes y Reportes] [Alertas de Caducidad] â—„â”€ NUEVO         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Vista: Lotes y Reportes

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BÃºsqueda de Lotes por Producto          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ID Producto: [___________] [Buscar]    â”‚
â”‚                                         â”‚
â”‚ Resultados:                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚ Producto: Arroz Premium           â”‚  â”‚
â”‚ â”‚ Lotes: 3 | Stock Total: 150 unid  â”‚  â”‚
â”‚ â”‚                                   â”‚  â”‚
â”‚ â”‚ CÃ³digo  â”‚ Cant â”‚  Vence  â”‚ Estado â”‚  â”‚
â”‚ â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”‚  â”‚
â”‚ â”‚ ARPre-A â”‚  10  â”‚2024-12-15â”‚ âš ï¸PrÃ³xâ”‚  â”‚
â”‚ â”‚ ARPre-B â”‚  85  â”‚2025-01-10â”‚ âœ“Ok  â”‚  â”‚
â”‚ â”‚ ARPre-C â”‚  55  â”‚2025-02-20â”‚ âœ“Ok  â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ InformaciÃ³n de Lotes                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Stock Total en Lotes: 150 unidades      â”‚
â”‚                                         â”‚
â”‚ CÃ³digo  â”‚ Cant â”‚  Vence  â”‚    Estado    â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ ARPre-A â”‚  10  â”‚2024-12-15â”‚ âš ï¸ PrÃ³ximo  â”‚
â”‚ ARPre-B â”‚  85  â”‚2025-01-10â”‚ âœ“ Vigente   â”‚
â”‚ ARPre-C â”‚  55  â”‚2025-02-20â”‚ âœ“ Vigente   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Vista: Alertas de Caducidad

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ”´ Lotes PrÃ³ximos a Caducarse              (4 lotes)
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Mostrar lotes que vencen en: [30 dÃ­as â–¼]          â”‚
â”‚                                                    â”‚
â”‚ ğŸ”´ ARPre-A | 10 unidades | Vence en 5 dÃ­as       â”‚
â”‚    Producto ID: 1 | 2024-12-15                    â”‚
â”‚                                                    â”‚
â”‚ ğŸŸ  LEche-B | 20 unidades | Vence en 12 dÃ­as      â”‚
â”‚    Producto ID: 4 | 2024-12-22                    â”‚
â”‚                                                    â”‚
â”‚ ğŸŸ¡ Fideos-C | 45 unidades | Vence en 28 dÃ­as     â”‚
â”‚    Producto ID: 2 | 2025-01-13                    â”‚
â”‚                                                    â”‚
â”‚ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•    â”‚
â”‚ ğŸ”´ CrÃ­tico (0-7) â”‚ ğŸŸ  Urgente (8-15) â”‚ ğŸŸ¡ Prec   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Estructura de Base de Datos

### Tabla: product_batches

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         product_batches              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¤
â”‚   id   â”‚productId â”‚batchCode  â”‚     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”‚
â”‚   1    â”‚    1     â”‚ ARPre-A    â”‚...  â”‚
â”‚   2    â”‚    1     â”‚ ARPre-B    â”‚...  â”‚
â”‚   3    â”‚    1     â”‚ ARPre-C    â”‚...  â”‚
â”‚   4    â”‚    2     â”‚ Fideos-A   â”‚...  â”‚
â”‚   5    â”‚    4     â”‚ Leche-A    â”‚...  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”˜

            â”‚
            â”œâ”€ quantity: Int
            â”œâ”€ expiryDate: String (YYYY-MM-DD)
            â””â”€ createdAt: DateTime
```

### RelaciÃ³n: Order â† OrderItem â†’ Product/Batch

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Order   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚ OrderItem    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚ Product â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ 1     n â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ n   1  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id      â”‚         â”‚ orderId      â”‚         â”‚ id      â”‚
â”‚ total   â”‚         â”‚ productId    â”‚         â”‚ title   â”‚
â”‚ status  â”‚         â”‚ quantity     â”‚         â”‚ stock   â”‚
â”‚ date    â”‚         â”‚ price        â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â”‚ via productId
                           â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ product_      â”‚
                    â”‚ batches      â”‚ â—„â”€ DESCUENTO FIFO
                    â”‚ (se descuentanâ”‚
                    â”‚  automÃ¡ticamente)
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Componentes React Relacionados

```
Dashboard (principal)
â”œâ”€ ExpiringBatchesAlert (NUEVO)
â”‚  â””â”€ Muestra alerta de caducidad
â”‚
â”œâ”€ BatchSearcher (NUEVO)
â”‚  â””â”€ BÃºsqueda por ID de producto
â”‚
â””â”€ BatchManager (MODIFICADO)
   â””â”€ VisualizaciÃ³n de lotes (solo lectura)
```

## Funciones Principales

### batch-service.ts

```javascript
consumeBatchesFIFO(productId, quantityToConsume)
  â”œâ”€ Obtiene lotes del producto
  â”œâ”€ Ordena por expiryDate ASC
  â”œâ”€ Itera y descuenta
  â””â”€ Lanza error si insuficiente

getBatchesByProduct(productId)
  â””â”€ Retorna array de Batch[]

getExpiringBatches(daysBefore)
  â””â”€ Retorna lotes prÃ³ximos a vencer
```

### inventory.ts

```javascript
createOrder(items[])
  â”œâ”€ Valida stock
  â”œâ”€ Crea Order
  â”œâ”€ Para cada item:
  â”‚  â”œâ”€ Crea OrderItem
  â”‚  â”œâ”€ Llama consumeBatchesFIFO() â—„â”€ NUEVO
  â”‚  â””â”€ updateStock('out')
  â””â”€ Retorna orderId
```

## Ventajas de la ImplementaciÃ³n

âœ… AutomÃ¡tico: No requiere intervenciÃ³n manual
âœ… Eficiente: FIFO optimizado por fecha de caducidad
âœ… Seguro: Transacciones atÃ³micas por orden
âœ… Observable: Alertas y bÃºsqueda en tiempo real
âœ… Escalable: Soporta mÃºltiples lotes por producto
âœ… Auditable: Trazabilidad completa de ventas
